<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard ‚Äî Hospital Management System</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    :root{
      --bg1:#071029; --bg2:#0b1224; --card:#07172a;
      --accent1:#06b6d4; --accent2:#a78bfa; --muted:#94a3b8;
      --glass: rgba(255,255,255,0.04); --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;height:100%;font-family:Inter, Poppins, system-ui;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:#e6eef8;-webkit-font-smoothing:antialiased;padding-bottom:60px;
    }

    .wrap{max-width:1300px;margin:26px auto;padding:0 20px;display:grid;grid-template-columns:260px 1fr;gap:20px}
    @media(max-width:980px){.wrap{grid-template-columns:1fr}}

    .sidebar{
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.04);padding:18px;border-radius:var(--radius);
      height:fit-content;position:sticky;top:20px;
    }
    .logo{font-weight:800;color:var(--accent1);display:flex;align-items:center;gap:10px;font-size:1.05rem}
    .nav{margin-top:18px;display:flex;flex-direction:column;gap:8px}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;color:#dbeafe;text-decoration:none;font-weight:600}
    .nav a:hover{background:linear-gradient(90deg,rgba(6,182,212,0.06),rgba(167,139,250,0.03));transform:translateX(6px)}
    .section-title{font-size:.9rem;color:var(--muted);margin-top:16px;margin-bottom:6px}

    .main{
      display:flex;flex-direction:column;gap:18px;
    }

    .topbar{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .top-left{display:flex;align-items:center;gap:12px}
    .page-title{font-size:1.4rem;font-weight:800;background:linear-gradient(90deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .top-actions{display:flex;gap:8px;align-items:center}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media(max-width:980px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{
      background:var(--glass);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
      display:flex;flex-direction:column;gap:6px;
      transition:transform .22s,box-shadow .22s;
    }
    .kpi:hover{transform:translateY(-6px);box-shadow:0 12px 36px rgba(6,182,212,0.06)}
    .kpi .label{color:var(--muted);font-size:.85rem}
    .kpi .num{font-weight:800;font-size:1.35rem}

    .grid-two{display:grid;grid-template-columns:1fr 420px;gap:12px;align-items:start}
    @media(max-width:980px){.grid-two{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.04);
    }

    .chart-wrap{display:flex;flex-direction:column;align-items:center;gap:8px}
    canvas{display:block;max-width:100%}

    .table-wrap{overflow:auto;margin-top:10px}
    table{width:100%;border-collapse:collapse;font-size:.95rem}
    th,td{padding:10px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
    th{color:var(--muted);font-weight:700;position:sticky;top:0;background:transparent}

    .row-actions{display:flex;gap:6px}
    .btn{padding:8px 10px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#031124}
    .small-muted{color:var(--muted);font-size:.9rem}

    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}

    .modal-back{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:120;opacity:0;pointer-events:none;transition:opacity .18s}
    .modal-back.show{opacity:1;pointer-events:auto}
    .modal{background:linear-gradient(180deg,#021124,#06102a);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);width:520px;max-width:96%}
    .modal h3{margin:0 0 8px 0}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:26px;padding:10px 14px;border-radius:12px;color:#021124;font-weight:700;z-index:220}

    .hamb{display:none}
    @media(max-width:700px){.nav{display:none}.hamb{display:block}}
    .confetti{position:fixed;z-index:300;border-radius:3px;pointer-events:none}

    .panel-title-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .mini-input{padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#fff}
  </style>
</head>
<body>

  <div class="wrap" role="main">
    <aside class="sidebar" aria-label="Sidebar">
      <div class="logo">üè• <span>HMS Admin</span></div>

      <div class="section-title">Quick Links</div>
      <nav class="nav" aria-label="Main navigation">
        <a href="index.html">Home</a>
        <a href="doctors.html">Doctors</a>
        <a href="appointment.html">Appointments</a>
        <a href="attendance.html">Attendance</a>
        <a href="admin.html" class="active">Admin</a>
      </nav>

      <div class="section-title">Admin Actions</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:6px">
        <button id="importAllBtn" class="btn ghost">Import Data (CSV)</button>
        <input id="importAllFile" type="file" accept=".csv" style="display:none"/>
        <button id="exportAllBtn" class="btn ghost">Export All</button>
        <button id="clearAllBtn" class="btn ghost">Clear All Storage</button>
      </div>

      <div class="section-title">Theme</div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="themeToggle" class="btn ghost">Toggle Accent</button>
      </div>
    </aside>

    <section class="main" aria-label="Admin content">
      <div class="topbar">
        <div class="top-left">
          <div class="page-title">Admin Dashboard</div>
          <div style="margin-left:10px" class="small-muted">Live control panel ‚Ä¢ Local demo</div>
        </div>

        <div class="top-actions">
          <div class="small-muted" id="nowClock">--:--</div>
          <button id="openAppointments" class="btn primary">Open Appointments</button>
        </div>
      </div>

      <div class="kpis" role="region" aria-label="Key performance indicators">
        <div class="kpi card">
          <div class="label">Total Doctors</div>
          <div class="num" id="k_doctors">0</div>
          <div class="small-muted">From dataset or static</div>
        </div>
        <div class="kpi card">
          <div class="label">Total Appointments</div>
          <div class="num" id="k_appointments">0</div>
          <div class="small-muted">All time</div>
        </div>
        <div class="kpi card">
          <div class="label">Present Today</div>
          <div class="num" id="k_present">0</div>
          <div class="small-muted">Today</div>
        </div>
        <div class="kpi card">
          <div class="label">% Present</div>
          <div class="num" id="k_percent">0%</div>
          <div class="small-muted">Ratio</div>
        </div>
      </div>

      <div class="grid-two">
        <div>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>Appointments by Doctor</strong>
              <div class="controls">
                <input id="apptSearch" class="mini-input" placeholder="Search appointments" />
                <button id="refreshBtn" class="btn ghost">Refresh</button>
                <button id="addSampleAppt" class="btn ghost">Add Sample</button>
              </div>
            </div>
            <div style="margin-top:12px" class="chart-wrap">
              <canvas id="barChart" width="800" height="220"></canvas>
            </div>

            <div class="table-wrap">
              <table id="apptTable" aria-label="Appointments table">
                <thead><tr><th>Patient</th><th>Doctor</th><th>Date</th><th>Time</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>Attendance (Today)</strong>
              <div class="controls">
                <input id="attSearch" class="mini-input" placeholder="Search attendance" />
                <button id="exportAtt" class="btn ghost">Export</button>
              </div>
            </div>

            <div style="margin-top:12px" class="chart-wrap">
              <canvas id="donutChart" width="220" height="220"></canvas>
            </div>

            <div class="table-wrap">
              <table id="attTable" aria-label="Attendance table">
                <thead><tr><th>Doctor</th><th>Status</th><th>Note</th><th>Time</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <aside class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Controls</strong>
            <div class="small-muted" id="lastUpdate">‚Äî</div>
          </div>

          <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
            <button id="exportAppointments" class="btn primary">Export Appointments CSV</button>
            <button id="exportAttendance" class="btn primary">Export Attendance CSV</button>
            <button id="importAppointmentsBtn" class="btn ghost">Import Appointments</button>
            <input id="importAppointmentsFile" type="file" accept=".csv" style="display:none"/>
            <button id="importAttendanceBtn" class="btn ghost">Import Attendance</button>
            <input id="importAttendanceFile" type="file" accept=".csv" style="display:none"/>
            <button id="clearAppointments" class="btn ghost">Clear Appointments</button>
            <button id="clearAttendance" class="btn ghost">Clear Attendance</button>
          </div>

          <div style="margin-top:14px">
            <strong class="small-muted">Quick preview</strong>
            <p class="small-muted" style="margin-top:8px">Click a row action to edit or delete items. Use Export to download CSVs.</p>
          </div>

          <hr style="margin:12px 0;border-color:rgba(255,255,255,0.03)">

          <div>
            <strong>Doctors Management</strong>
            <div style="margin-top:10px;display:flex;gap:8px;">
              <input id="newDoctorName" class="mini-input" placeholder="Name" />
              <input id="newDoctorSpec" class="mini-input" placeholder="Specialty" />
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <select id="newDoctorStatus" class="mini-input" style="min-width:120px">
                <option value="available">Available</option>
                <option value="busy">Busy</option>
              </select>
              <button id="addDoctorBtn" class="btn primary">Add Doctor</button>
            </div>

            <div class="table-wrap" style="margin-top:12px;">
              <table id="doctorTable">
                <thead><tr><th>Name</th><th>Specialty</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </aside>
      </div>

      <footer>¬© 2025 Hospital Management ‚Ä¢ Admin Panel by Vansh</footer>
    </section>
  </div>

  <div id="modal" class="modal-back" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Confirm</h3>
      <div id="modalBody" class="small-muted" style="margin-top:6px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="modalCancel" class="btn ghost">Cancel</button>
        <button id="modalOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <div id="toastWrap"></div>

  <script>
  (function(){
    // Storage keys
    const DOCTORS_KEY = 'doctors';
    const APPT_KEY = 'appointments';
    const ATT_KEY = 'hms_attendance_v1';

    // DOM helpers
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // elements
    const apptTableBody = $('#apptTable tbody');
    const attTableBody = $('#attTable tbody');
    const docTableBody = $('#doctorTable tbody');

    const kDoctors = $('#k_doctors'), kAppts = $('#k_appointments'), kPresent = $('#k_present'), kPercent = $('#k_percent');
    const apptSearch = $('#apptSearch'), attSearch = $('#attSearch'), refreshBtn = $('#refreshBtn'), addSampleAppt = $('#addSampleAppt');

    const exportAppointments = $('#exportAppointments'), exportAttendance = $('#exportAttendance');
    const importAppointmentsBtn = $('#importAppointmentsBtn'), importAppointmentsFile = $('#importAppointmentsFile');
    const importAttendanceBtn = $('#importAttendanceBtn'), importAttendanceFile = $('#importAttendanceFile');
    const clearAppointmentsBtn = $('#clearAppointments'), clearAttendanceBtn = $('#clearAttendance');

    const importAllBtn = $('#importAllBtn'), importAllFile = $('#importAllFile'), exportAllBtn = $('#exportAllBtn'), clearAllBtn = $('#clearAllBtn');
    const themeToggle = $('#themeToggle'), openAppointments = $('#openAppointments');

    const newDoctorName = $('#newDoctorName'), newDoctorSpec = $('#newDoctorSpec'), newDoctorStatus = $('#newDoctorStatus'), addDoctorBtn = $('#addDoctorBtn');

    const modalBack = $('#modal'), modalTitle = $('#modalTitle'), modalBody = $('#modalBody'), modalOk = $('#modalOk'), modalCancel = $('#modalCancel');

    function now(){ return new Date(); }
    function fmt(d){ const p=n=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+' '+p(d.getHours())+':'+p(d.getMinutes())+':'+p(d.getSeconds()); }
    function todayKey(d=new Date()){ const p=n=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate()); }

    function load(key){ try{ return JSON.parse(localStorage.getItem(key) || '[]'); }catch(e){ return []; } }
    function save(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); window.dispatchEvent(new Event('storage')); }

    function toast(text, success=true){
      const t = document.createElement('div'); t.className='toast'; t.textContent=text;
      t.style.background = success ? 'linear-gradient(90deg,var(--accent1),var(--accent2))' : 'rgba(250,120,120,0.95)';
      t.style.color = success ? '#021124' : '#fff';
      document.body.appendChild(t);
      setTimeout(()=> t.style.opacity='0', 1800); setTimeout(()=> t.remove(), 2400);
    }

    function uid(prefix='id'){ return prefix + Date.now() + Math.floor(Math.random()*999); }

    // default doctors if none exist
    function ensureDefaultDoctors(){
      const d = load(DOCTORS_KEY);
      if(d.length === 0){
        const defaults = [
          { id: uid('D'), name: 'Dr. Ayesha Singh', specialty: 'Cardiologist', status: 'available', image:'', createdAt: new Date().toISOString() },
          { id: uid('D'), name: 'Dr. Raj Mehta', specialty: 'Neurologist', status: 'busy', image:'', createdAt: new Date().toISOString() },
          { id: uid('D'), name: 'Dr. Priya Kapoor', specialty: 'Pediatrician', status: 'available', image:'', createdAt: new Date().toISOString() },
          { id: uid('D'), name: 'Dr. Vikram Sharma', specialty: 'Orthopedic Surgeon', status: 'busy', image:'', createdAt: new Date().toISOString() }
        ];
        save(DOCTORS_KEY, defaults);
      }
    }

    // Render functions
    function computeKPIs(){
      const doctors = load(DOCTORS_KEY);
      const appts = load(APPT_KEY);
      const atts = load(ATT_KEY);
      const presentToday = (atts.filter(r => (r.dateKey || (r.time && r.time.slice(0,10))) === todayKey()) ).filter(r => r.status === 'Present').length;
      const totalDoctors = doctors.length;
      const totalAppts = appts.length;
      const percent = (() => {
        const today = (atts.filter(r => (r.dateKey || (r.time && r.time.slice(0,10))) === todayKey()));
        if(!today.length) return 0;
        return Math.round((today.filter(x => x.status === 'Present').length / today.length) * 100);
      })();
      kDoctors.textContent = totalDoctors;
      kAppts.textContent = totalAppts;
      kPresent.textContent = presentToday;
      kPercent.textContent = percent + '%';
    }

    function renderAppointments(filter=''){
      const arr = load(APPT_KEY);
      const q = (filter || '').toLowerCase();
      const list = arr.slice().reverse().filter(a => !q || (a.name||'').toLowerCase().includes(q) || (a.doctor||'').toLowerCase().includes(q));
      apptTableBody.innerHTML = '';
      list.forEach((a, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHTML(a.name||'‚Äî')}</td>
                        <td>${escapeHTML(a.doctor||'‚Äî')}</td>
                        <td>${escapeHTML(a.date||'‚Äî')}</td>
                        <td>${escapeHTML(a.time||'‚Äî')}</td>
                        <td><div class="row-actions">
                          <button class="btn ghost editAppt" data-id="${a.id}">Edit</button>
                          <button class="btn ghost delAppt" data-id="${a.id}">Delete</button>
                        </div></td>`;
        apptTableBody.appendChild(tr);
      });
      chartAppointments();
    }

    function renderAttendance(filter=''){
      const arr = load(ATT_KEY);
      const q = (filter || '').toLowerCase();
      const list = arr.slice().reverse().filter(a => !q || (a.name||'').toLowerCase().includes(q) || (a.note||'').toLowerCase().includes(q));
      attTableBody.innerHTML = '';
      list.forEach(a => {
        const tr = document.createElement('tr');
        const statusBadge = a.status === 'Present' ? `<span style="color:#22c55e;font-weight:700">Present</span>` : `<span style="color:#ef4444;font-weight:700">Absent</span>`;
        tr.innerHTML = `<td>${escapeHTML(a.name||'‚Äî')}</td>
                        <td>${statusBadge}</td>
                        <td>${escapeHTML(a.note||'‚Äî')}</td>
                        <td>${escapeHTML(a.time||'‚Äî')}</td>
                        <td><div class="row-actions">
                          <button class="btn ghost delAtt" data-id="${a.id}">Delete</button>
                        </div></td>`;
        attTableBody.appendChild(tr);
      });
      chartAttendance();
    }

    function renderDoctors(){
      const arr = load(DOCTORS_KEY);
      docTableBody.innerHTML = '';
      arr.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHTML(d.name)}</td>
                        <td>${escapeHTML(d.specialty)}</td>
                        <td>${escapeHTML(d.status)}</td>
                        <td><div class="row-actions">
                          <button class="btn ghost editDoc" data-id="${d.id}">Edit</button>
                          <button class="btn ghost delDoc" data-id="${d.id}">Delete</button>
                        </div></td>`;
        docTableBody.appendChild(tr);
      });
    }

    // Charts (simple canvas rendering)
    function chartAttendance(){
      const canvas = $('#donutChart');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const atts = load(ATT_KEY);
      const today = atts.filter(r => (r.dateKey || (r.time && r.time.slice(0,10))) === todayKey());
      const present = today.filter(x => x.status === 'Present').length;
      const absent = today.filter(x => x.status === 'Absent').length;
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);
      const total = Math.max(1, present + absent);
      const presentAngle = (present / total) * Math.PI * 2;
      const cx = w/2, cy = h/2, r = Math.min(w,h)/2 - 18;
      // background ring
      ctx.lineWidth = 18; ctx.beginPath(); ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
      // present arc
      const grad = ctx.createLinearGradient(0,0,w,h); grad.addColorStop(0,'#06b6d4'); grad.addColorStop(1,'#a78bfa');
      ctx.strokeStyle = grad; ctx.beginPath(); ctx.arc(cx,cy,r,-Math.PI/2, -Math.PI/2 + presentAngle); ctx.stroke();
      ctx.fillStyle = "#e6eef8"; ctx.font = "700 18px Inter, Poppins"; ctx.textAlign = "center"; ctx.fillText(String(present),cx,cy-2);
      ctx.fillStyle = "rgba(255,255,255,0.65)"; ctx.font = "400 12px Inter, Poppins"; ctx.fillText("Present",cx,cy+16);
    }

    function chartAppointments(){
      const canvas = $('#barChart');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const appts = load(APPT_KEY);
      const counts = {};
      appts.forEach(a => { counts[a.doctor] = (counts[a.doctor] || 0) + 1; });
      const doctors = Object.keys(counts).length ? Object.keys(counts) : load(DOCTORS_KEY).map(d => d.name);
      const values = doctors.map(d => counts[d] || 0);
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);
      const max = Math.max(1, ...values);
      const pad = 40;
      const barW = (w - pad*2) / doctors.length * 0.6;
      doctors.forEach((d,i) => {
        const x = pad + i * ((w - pad*2)/doctors.length) + (((w - pad*2)/doctors.length - barW)/2);
        const bh = (values[i]/max) * (h - 80);
        // subtle background
        ctx.fillStyle = 'rgba(255,255,255,0.03)'; ctx.fillRect(x, h-40-bh, barW, bh);
        const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#06b6d4'); g.addColorStop(1,'#a78bfa');
        ctx.fillStyle = g; ctx.fillRect(x, h-40-bh, barW, bh*0.95);
        ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.font = '700 12px Inter, Poppins'; ctx.textAlign = 'center';
        ctx.fillText(values[i], x + barW/2, h-48-bh);
        ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.font = '600 12px Inter, Poppins';
        ctx.fillText(d, x + barW/2, h-14);
      });
    }

    function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // Modals
    function confirmModal(title, body){
      return new Promise((resolve) => {
        modalTitle.textContent = title;
        modalBody.textContent = body;
        modalBack.classList.add('show');
        modalBack.setAttribute('aria-hidden','false');
        function clean(){
          modalBack.classList.remove('show');
          modalBack.setAttribute('aria-hidden','true');
          modalOk.removeEventListener('click', onOk);
          modalCancel.removeEventListener('click', onCancel);
        }
        function onOk(){ clean(); resolve(true); }
        function onCancel(){ clean(); resolve(false); }
        modalOk.addEventListener('click', onOk);
        modalCancel.addEventListener('click', onCancel);
      });
    }

    // CRUD functions
    function addDoctor(obj){
      const arr = load(DOCTORS_KEY);
      obj.id = obj.id || uid('D');
      arr.push(obj);
      save(DOCTORS_KEY, arr);
      renderAll();
      toast('Doctor added');
    }

    function updateDoctor(id, patch){
      const arr = load(DOCTORS_KEY);
      const idx = arr.findIndex(x=>x.id===id); if(idx === -1) return false;
      arr[idx] = {...arr[idx], ...patch};
      save(DOCTORS_KEY, arr); renderAll(); toast('Doctor updated');
      return true;
    }

    async function deleteDoctor(id){
      const doctors = load(DOCTORS_KEY);
      const doc = doctors.find(d => d.id===id);
      if(!doc) return;
      // ask whether to also delete related appointments
      const ok = await confirmModal('Delete doctor', `Delete ${doc.name}? Also remove related appointments?`);
      if(!ok) return;
      // remove doctor
      const newDocs = doctors.filter(d => d.id !== id);
      save(DOCTORS_KEY, newDocs);
      // remove appointments referencing that doctor name
      const appts = load(APPT_KEY);
      const rem = appts.filter(a => a.doctor === doc.name);
      if(rem.length){
        // remove them
        const filtered = appts.filter(a => a.doctor !== doc.name);
        save(APPT_KEY, filtered);
      }
      renderAll();
      toast('Doctor and related appointments removed');
    }

    function addAppointment(obj){
      const arr = load(APPT_KEY);
      obj.id = obj.id || uid('A');
      obj.createdAt = new Date().toISOString();
      arr.push(obj);
      save(APPT_KEY, arr);
      renderAll();
      toast('Appointment added');
    }

    function updateAppointment(id, patch){
      const arr = load(APPT_KEY);
      const idx = arr.findIndex(x=>x.id===id); if(idx === -1) return false;
      arr[idx] = {...arr[idx], ...patch};
      save(APPT_KEY, arr); renderAll(); toast('Appointment updated');
      return true;
    }

    async function deleteAppointment(id){
      const ok = await confirmModal('Delete appointment', 'Delete this appointment?');
      if(!ok) return;
      const arr = load(APPT_KEY).filter(a => a.id !== id);
      save(APPT_KEY, arr);
      renderAll();
      toast('Appointment deleted');
    }

    async function deleteAttendance(id){
      const ok = await confirmModal('Delete attendance', 'Delete this attendance record?');
      if(!ok) return;
      const arr = load(ATT_KEY).filter(a => a.id !== id);
      save(ATT_KEY, arr);
      renderAll();
      toast('Attendance deleted');
    }

    // import/export helpers
    function exportCSV(data, headers, filename){
      const lines = [headers.join(',')];
      data.forEach(row => {
        const vals = headers.map(h => `"${String(row[h]||'').replace(/"/g,'""')}"`);
        lines.push(vals.join(','));
      });
      const blob = new Blob([lines.join('\n')], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function importCSVFile(file, key){
      return new Promise((resolve,reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const text = e.target.result;
            const lines = text.split(/\r?\n/).filter(Boolean);
            const header = lines.shift().split(',').map(h => h.replace(/"/g,'').trim());
            const arr = load(key);
            lines.forEach(line => {
              const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
              const obj = {};
              header.forEach((h,i) => obj[h] = (cols[i]||'').replace(/^"|"$/g,''));
              if(key === APPT_KEY){
                arr.push({ id: uid('A'), name: obj.name||'Unknown', doctor: obj.doctor||'', date: obj.date||'', time: obj.time||'', note: obj.note||'', createdAt: new Date().toISOString() });
              } else if (key === ATT_KEY){
                arr.push({ id: uid('AT'), name: obj.name||'Unknown', status: obj.status||'Present', time: obj.time||fmt(new Date()), note: obj.note||'', dateKey: obj.dateKey||todayKey() });
              } else if (key === DOCTORS_KEY){
                arr.push({ id: uid('D'), name: obj.name||'Unknown', specialty: obj.specialty||'', status: obj.status||'available', image:'', createdAt: new Date().toISOString() });
              }
            });
            save(key, arr);
            resolve();
          } catch(err){ reject(err); }
        };
        reader.readAsText(file);
      });
    }

    // events
    apptSearch.addEventListener('input', () => renderAppointments(apptSearch.value));
    attSearch.addEventListener('input', () => renderAttendance(attSearch.value));
    refreshBtn.addEventListener('click', ()=> { renderAll(); toast('Refreshed'); });
    addSampleAppt.addEventListener('click', () => {
      const docs = load(DOCTORS_KEY).map(d => d.name);
      const arr = load(APPT_KEY);
      const d = new Date(); const dt = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
      arr.push({ id: uid('A'), name: 'Sample Patient ' + (arr.length+1), doctor: docs[arr.length % Math.max(1,docs.length)] || 'Dr. Ayesha Singh', date: dt, time: String(d.getHours()).padStart(2,'0')+':00', note: 'Auto sample', createdAt: new Date().toISOString() });
      save(APPT_KEY, arr); renderAll(); burst(); toast('Sample appointment added');
    });

    exportAppointments.addEventListener('click', () => {
      const arr = load(APPT_KEY);
      exportCSV(arr, ['name','doctor','date','time','note'], 'appointments_export.csv');
    });
    exportAttendance.addEventListener('click', () => {
      const arr = load(ATT_KEY);
      exportCSV(arr, ['id','name','status','time','note','dateKey'], 'attendance_export.csv');
    });

    importAppointmentsBtn.addEventListener('click', () => importAppointmentsFile.click());
    importAppointmentsFile.addEventListener('change', async (e) => {
      const f = e.target.files[0]; if(!f) return;
      await importCSVFile(f, APPT_KEY);
      e.target.value = ''; renderAll(); toast('Appointments imported');
    });

    importAttendanceBtn.addEventListener('click', () => importAttendanceFile.click());
    importAttendanceFile.addEventListener('change', async (e) => {
      const f = e.target.files[0]; if(!f) return;
      await importCSVFile(f, ATT_KEY);
      e.target.value = ''; renderAll(); toast('Attendance imported');
    });

    importAllBtn.addEventListener('click', () => importAllFile.click());
    importAllFile.addEventListener('change', async (e) => {
      const f = e.target.files[0]; if(!f) return;
      // attempt to import into both (best-effort)
      await importCSVFile(f, APPT_KEY).catch(()=>{});
      await importCSVFile(f, ATT_KEY).catch(()=>{});
      await importCSVFile(f, DOCTORS_KEY).catch(()=>{});
      e.target.value = ''; renderAll(); toast('Import attempted');
    });

    exportAllBtn.addEventListener('click', () => {
      const a = load(APPT_KEY), b = load(ATT_KEY), c = load(DOCTORS_KEY);
      exportCSV(a, ['name','doctor','date','time','note'], 'appointments_export.csv');
      exportCSV(b, ['id','name','status','time','note','dateKey'], 'attendance_export.csv');
      exportCSV(c, ['name','specialty','status'], 'doctors_export.csv');
    });

    clearAppointmentsBtn.addEventListener('click', async () => {
      const ok = await confirmModal('Clear appointments', 'Delete all appointments permanently?');
      if(!ok) return;
      save(APPT_KEY, []); renderAll(); toast('Appointments cleared');
    });
    clearAttendanceBtn.addEventListener('click', async () => {
      const ok = await confirmModal('Clear attendance', 'Delete all attendance permanently?');
      if(!ok) return;
      save(ATT_KEY, []); renderAll(); toast('Attendance cleared');
    });
    clearAllBtn.addEventListener('click', async () => {
      const ok = await confirmModal('Clear all data', 'This will clear appointments, attendance and doctors. Continue?');
      if(!ok) return;
      save(APPT_KEY, []); save(ATT_KEY, []); save(DOCTORS_KEY, []); renderAll(); toast('All storage cleared');
    });

    themeToggle.addEventListener('click', () => {
      const cur1 = getComputedStyle(document.documentElement).getPropertyValue('--accent1').trim();
      document.documentElement.style.setProperty('--accent1', cur1 === '#06b6d4' ? '#f97316' : '#06b6d4');
      const cur2 = getComputedStyle(document.documentElement).getPropertyValue('--accent2').trim();
      document.documentElement.style.setProperty('--accent2', cur2 === '#a78bfa' ? '#fb7185' : '#a78bfa');
      toast('Accent toggled');
    });

    openAppointments.addEventListener('click', () => { window.location.href = 'appointment.html'; });

    // Doctor add/edit/delete UI handlers
    addDoctorBtn.addEventListener('click', () => {
      const name = (newDoctorName.value||'').trim();
      const spec = (newDoctorSpec.value||'').trim();
      const status = (newDoctorStatus.value||'available');
      if(!name || !spec){ toast('Name & specialty required', false); return; }
      addDoctor({ name, specialty: spec, status, image:'', createdAt: new Date().toISOString() });
      newDoctorName.value=''; newDoctorSpec.value='';
    });

    // delegate table buttons
    document.body.addEventListener('click', (e) => {
      if(e.target.matches('.delDoc')){
        const id = e.target.getAttribute('data-id'); deleteDoctor(id);
      } else if (e.target.matches('.editDoc')){
        const id = e.target.getAttribute('data-id');
        const doctors = load(DOCTORS_KEY); const doc = doctors.find(d => d.id === id);
        if(!doc) return;
        const name = prompt('Full name', doc.name); if(name === null) return;
        const specialty = prompt('Specialty', doc.specialty); if(specialty === null) return;
        const status = prompt('Status (available/busy)', doc.status) || doc.status;
        updateDoctor(id, { name: name.trim(), specialty: specialty.trim(), status: status.trim() });
      } else if (e.target.matches('.delAppt')){
        const id = e.target.getAttribute('data-id'); deleteAppointment(id);
      } else if (e.target.matches('.editAppt')){
        const id = e.target.getAttribute('data-id'); const appts = load(APPT_KEY); const a = appts.find(x=>x.id===id);
        if(!a) return;
        const name = prompt('Patient name', a.name); if(name === null) return;
        const doctor = prompt('Doctor', a.doctor); if(doctor === null) return;
        const date = prompt('Date (YYYY-MM-DD)', a.date); if(date === null) return;
        const time = prompt('Time (HH:MM)', a.time); if(time === null) return;
        const note = prompt('Note', a.note||'') || a.note;
        updateAppointment(id, { name: name.trim(), doctor: doctor.trim(), date: date.trim(), time: time.trim(), note: note.trim() });
      } else if (e.target.matches('.delAtt')){
        const id = e.target.getAttribute('data-id'); deleteAttendance(id);
      }
    });

    // Add small burst confetti
    function burst(){
      for(let i=0;i<20;i++){
        const p = document.createElement('div'); p.className='confetti';
        p.style.left = (20 + Math.random()*60) + '%';
        p.style.top = (10 + Math.random()*20) + '%';
        p.style.width = (6 + Math.random()*8) + 'px';
        p.style.height = (8 + Math.random()*8) + 'px';
        p.style.background = ['#06b6d4','#a78bfa','#34d399','#f472b6'][Math.floor(Math.random()*4)];
        document.body.appendChild(p);
        const dx = (Math.random()*800 - 400), dy = (200 + Math.random()*400);
        p.animate([{transform:'translate(0,0) rotate(0deg)',opacity:1},{transform:`translate(${dx}px,${dy}px) rotate(${Math.random()*720}deg)`,opacity:0}],{duration:900+Math.random()*800,easing:'cubic-bezier(.12,.8,.2,1)'});
        setTimeout(()=> p.remove(), 1800);
      }
    }

    // CSV helper used above (reusing importCSVFile)
    async function importCSVFile(file, key){
      try {
        await importCSVFileWorker(file, key);
      } catch(e){
        console.error('Import failed', e);
        toast('Import failed', false);
      }
    }
    function importCSVFileWorker(file, key){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          try{
            const text = e.target.result;
            const lines = text.split(/\r?\n/).filter(Boolean);
            if(lines.length < 1) return resolve();
            const header = lines.shift().split(',').map(h => h.replace(/"/g,'').trim());
            const arr = load(key);
            lines.forEach(line => {
              const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
              const obj = {};
              header.forEach((h,i) => obj[h] = (cols[i] || '').replace(/^"|"$/g,''));
              if(key === APPT_KEY){
                arr.push({ id: uid('A'), name: obj.name||'Unknown', doctor: obj.doctor||'', date: obj.date||'', time: obj.time||'', note: obj.note||'', createdAt: new Date().toISOString() });
              } else if (key === ATT_KEY){
                arr.push({ id: uid('AT'), name: obj.name||'Unknown', status: obj.status||'Present', time: obj.time||fmt(new Date()), note: obj.note||'', dateKey: obj.dateKey||todayKey() });
              } else if (key === DOCTORS_KEY){
                arr.push({ id: uid('D'), name: obj.name||'Unknown', specialty: obj.specialty||'', status: obj.status||'available', image:'', createdAt: new Date().toISOString() });
              }
            });
            save(key, arr);
            resolve();
          } catch(err){ reject(err); }
        };
        reader.readAsText(file);
      });
    }

    // initial setup
    ensureDefaultDoctors();

    function renderAll(){ computeKPIs(); renderAppointments(); renderAttendance(); renderDoctors(); $('#lastUpdate').textContent = 'Updated ' + new Date().toLocaleString(); }

    // storage event listener for multi-tab sync
    window.addEventListener('storage', (e) => {
      if([APPT_KEY, ATT_KEY, DOCTORS_KEY].includes(e.key) || e.key === null){
        renderAll();
      }
    });

    // export helpers calling the above defined functions
    $('#exportAllBtn').addEventListener('click', () => {
      const a = load(APPT_KEY), b = load(ATT_KEY), c = load(DOCTORS_KEY);
      exportCSV(a, ['name','doctor','date','time','note'], 'appointments_export.csv');
      exportCSV(b, ['id','name','status','time','note','dateKey'], 'attendance_export.csv');
      exportCSV(c, ['name','specialty','status'], 'doctors_export.csv');
    });

    // import (wired to hidden input) handled above using importAllFile

    // small clock update
    setInterval(() => { $('#nowClock').textContent = new Date().toLocaleTimeString(); }, 1000);

    // initial render
    renderAll();

    // utility: delegate delete/edit actions using event delegation already above
    // ensure edit / delete buttons created will work as created earlier.

    // expose renderAll for debugging
    window.adminRenderAll = renderAll;

  })();
  </script>
</body>
</html>
