<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard ‚Äî Hospital Management System</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    :root{
      --bg1:#071029; --bg2:#0b1224; --card:#07172a;
      --accent1:#06b6d4; --accent2:#a78bfa; --muted:#94a3b8;
      --glass: rgba(255,255,255,0.04); --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;height:100%;font-family:Inter, Poppins, system-ui;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:#e6eef8;-webkit-font-smoothing:antialiased;padding-bottom:60px;
    }

    .wrap{max-width:1300px;margin:26px auto;padding:0 20px;display:grid;grid-template-columns:260px 1fr;gap:20px}
    @media(max-width:980px){.wrap{grid-template-columns:1fr}}

    .sidebar{
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.04);padding:18px;border-radius:var(--radius);
      height:fit-content;position:sticky;top:20px;
    }
    .logo{font-weight:800;color:var(--accent1);display:flex;align-items:center;gap:10px;font-size:1.05rem}
    .nav{margin-top:18px;display:flex;flex-direction:column;gap:8px}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;color:#dbeafe;text-decoration:none;font-weight:600}
    .nav a:hover{background:linear-gradient(90deg,rgba(6,182,212,0.06),rgba(167,139,250,0.03));transform:translateX(6px)}
    .section-title{font-size:.9rem;color:var(--muted);margin-top:16px;margin-bottom:6px}

    .main{
      display:flex;flex-direction:column;gap:18px;
    }

    .topbar{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .top-left{display:flex;align-items:center;gap:12px}
    .page-title{font-size:1.4rem;font-weight:800;background:linear-gradient(90deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .top-actions{display:flex;gap:8px;align-items:center}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media(max-width:980px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{
      background:var(--glass);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
      display:flex;flex-direction:column;gap:6px;
      transition:transform .22s,box-shadow .22s;
    }
    .kpi:hover{transform:translateY(-6px);box-shadow:0 12px 36px rgba(6,182,212,0.06)}
    .kpi .label{color:var(--muted);font-size:.85rem}
    .kpi .num{font-weight:800;font-size:1.35rem}

    .grid-two{display:grid;grid-template-columns:1fr 420px;gap:12px;align-items:start}
    @media(max-width:980px){.grid-two{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.04);
    }

    .chart-wrap{display:flex;flex-direction:column;align-items:center;gap:8px}
    canvas{display:block;max-width:100%}

    .table-wrap{overflow:auto;margin-top:10px}
    table{width:100%;border-collapse:collapse;font-size:.95rem}
    th,td{padding:10px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
    th{color:var(--muted);font-weight:700;position:sticky;top:0;background:transparent}

    .row-actions{display:flex;gap:6px}
    .btn{padding:8px 10px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#031124}
    .small-muted{color:var(--muted);font-size:.9rem}

    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}

    .modal-back{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:120;opacity:0;pointer-events:none;transition:opacity .18s}
    .modal-back.show{opacity:1;pointer-events:auto}
    .modal{background:linear-gradient(180deg,#021124,#06102a);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);width:520px;max-width:96%}
    .modal h3{margin:0 0 8px 0}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:26px;padding:10px 14px;border-radius:12px;color:#021124;font-weight:700;z-index:220}

    .hamb{display:none}
    @media(max-width:700px){.nav{display:none}.hamb{display:block}}
    .confetti{position:fixed;z-index:300;border-radius:3px;pointer-events:none}

    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:.85rem}
  </style>
</head>
<body>

  <div class="wrap" role="main">
    <aside class="sidebar" aria-label="Sidebar">
      <div class="logo">üè• <span>HMS Admin</span></div>

      <div class="section-title">Quick Links</div>
      <nav class="nav" aria-label="Main navigation">
        <a href="index.html">Home</a>
        <a href="doctors.html">Doctors</a>
        <a href="appointment.html">Appointments</a>
        <a href="attendance.html">Attendance</a>
        <a href="admin.html" class="active">Admin</a>
      </nav>

      <div class="section-title">Admin Actions</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:6px">
        <button id="importAllBtn" class="btn ghost">Import Data (CSV)</button>
        <input id="importAllFile" type="file" accept=".csv" style="display:none"/>
        <button id="exportAllBtn" class="btn ghost">Export All</button>
        <button id="clearAllBtn" class="btn ghost">Clear All Storage</button>
      </div>

      <div class="section-title">Theme</div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="themeToggle" class="btn ghost">Toggle Accent</button>
      </div>
    </aside>

    <section class="main" aria-label="Admin content">
      <div class="topbar">
        <div class="top-left">
          <div class="page-title">Admin Dashboard</div>
          <div style="margin-left:10px" class="small-muted">Live control panel ‚Ä¢ Local demo</div>
        </div>

        <div class="top-actions">
          <div class="small-muted" id="nowClock">--:--</div>
          <button id="openAppointments" class="btn primary">Open Appointments</button>
        </div>
      </div>

      <div class="kpis" role="region" aria-label="Key performance indicators">
        <div class="kpi card">
          <div class="label">Total Doctors</div>
          <div class="num" id="k_doctors">0</div>
          <div class="small-muted">From dataset or static</div>
        </div>
        <div class="kpi card">
          <div class="label">Total Appointments</div>
          <div class="num" id="k_appointments">0</div>
          <div class="small-muted">All time</div>
        </div>
        <div class="kpi card">
          <div class="label">Present Today</div>
          <div class="num" id="k_present">0</div>
          <div class="small-muted">Today</div>
        </div>
        <div class="kpi card">
          <div class="label">% Present</div>
          <div class="num" id="k_percent">0%</div>
          <div class="small-muted">Ratio</div>
        </div>
      </div>

      <div class="grid-two">
        <div>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>Appointments by Doctor</strong>
              <div class="controls">
                <input id="apptSearch" class="input" placeholder="Search appointments" style="padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#fff"/>
                <button id="refreshBtn" class="btn ghost">Refresh</button>
                <button id="addSampleAppt" class="btn ghost">Add Sample</button>
              </div>
            </div>
            <div style="margin-top:12px" class="chart-wrap">
              <canvas id="barChart" width="800" height="220"></canvas>
            </div>

            <div class="table-wrap">
              <table id="apptTable" aria-label="Appointments table">
                <thead><tr><th>Patient</th><th>Doctor</th><th>Date</th><th>Time</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>Attendance (Today)</strong>
              <div class="controls">
                <input id="attSearch" class="input" placeholder="Search attendance" style="padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#fff"/>
                <button id="exportAtt" class="btn ghost">Export</button>
              </div>
            </div>

            <div style="margin-top:12px" class="chart-wrap">
              <canvas id="donutChart" width="220" height="220"></canvas>
            </div>

            <div class="table-wrap">
              <table id="attTable" aria-label="Attendance table">
                <thead><tr><th>Doctor</th><th>Status</th><th>Note</th><th>Time</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <aside class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Controls</strong>
            <div class="small-muted" id="lastUpdate">‚Äî</div>
          </div>

          <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
            <button id="exportAppointments" class="btn primary">Export Appointments CSV</button>
            <button id="exportAttendance" class="btn primary">Export Attendance CSV</button>
            <button id="importAppointmentsBtn" class="btn ghost">Import Appointments</button>
            <input id="importAppointmentsFile" type="file" accept=".csv" style="display:none"/>
            <button id="importAttendanceBtn" class="btn ghost">Import Attendance</button>
            <input id="importAttendanceFile" type="file" accept=".csv" style="display:none"/>
            <button id="clearAppointments" class="btn ghost">Clear Appointments</button>
            <button id="clearAttendance" class="btn ghost">Clear Attendance</button>
          </div>

          <div style="margin-top:14px">
            <strong class="small-muted">Quick preview</strong>
            <p class="small-muted" style="margin-top:8px">Click a row action to edit or delete items. Use Export to download CSVs.</p>
          </div>
        </aside>
      </div>

      <footer>¬© 2025 Hospital Management ‚Ä¢ Admin Panel by Vansh</footer>
    </section>
  </div>

  <div id="modal" class="modal-back" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Confirm</h3>
      <div id="modalBody" class="small-muted" style="margin-top:6px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="modalCancel" class="btn ghost">Cancel</button>
        <button id="modalOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <div id="toastWrap"></div>

  <script>
  (function(){
    var apptKey = 'appointments';
    var attKey = 'hms_attendance_v1';

    function $q(s){return document.querySelector(s)}
    function $qa(s){return Array.from(document.querySelectorAll(s))}
    function now(){return new Date()}
    function fmt(d){var p=n=>String(n).padStart(2,'0');return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+' '+p(d.getHours())+':'+p(d.getMinutes())+':'+p(d.getSeconds())}
    function todayKey(d){d=d||new Date(); var p=n=>String(n).padStart(2,'0');return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())}

    function load(key){try{return JSON.parse(localStorage.getItem(key)||'[]')}catch(e){return []}}
    function save(key,arr){localStorage.setItem(key,JSON.stringify(arr))}

    function toast(text){
      var t=document.createElement('div');t.className='toast';t.textContent=text;
      t.style.background='linear-gradient(90deg,var(--accent1),var(--accent2))';document.body.appendChild(t);
      setTimeout(()=>t.style.opacity='0',2000);setTimeout(()=>t.remove(),2700);
    }

    function burst(){
      for(var i=0;i<20;i++){
        var p=document.createElement('div');p.className='confetti';
        p.style.left=(20+Math.random()*60)+'%';p.style.top=(10+Math.random()*20)+'%';
        p.style.width=(6+Math.random()*8)+'px';p.style.height=(8+Math.random()*8)+'px';
        p.style.background=['#06b6d4','#a78bfa','#34d399','#f472b6'][Math.floor(Math.random()*4)];
        document.body.appendChild(p);
        var dx=(Math.random()*800-400),dy=(200+Math.random()*400);
        p.animate([{transform:'translate(0,0) rotate(0deg)',opacity:1},{transform:'translate('+dx+'px,'+dy+'px) rotate('+ (Math.random()*720) +'deg)',opacity:0}],{duration:900+Math.random()*800,easing:'cubic-bezier(.12,.8,.2,1)'});
        setTimeout(()=>p.remove(),1800);
      }
    }

    function parseDate(v){if(!v) return null; var d=new Date(v); if(isNaN(d)) d=new Date(v.replace(/-/g,'/')); return d}

    function computeKPIs(){
      var doctorsSet=new Set();
      var appts=load(apptKey);
      appts.forEach(a=>{ if(a.doctor) doctorsSet.add(a.doctor) });
      var atts=load(attKey);
      var totalDoctors=doctorsSet.size || getStaticDoctors().length;
      var totalAppts=appts.length;
      var today=todayKey();
      var todayAtt=atts.filter(r=> (r.dateKey|| (r.time && r.time.slice(0,10))) === today);
      var present=todayAtt.filter(r=>r.status==='Present').length;
      var percent = todayAtt.length ? Math.round((present/todayAtt.length)*100) : 0;
      $q('#k_doctors').textContent = totalDoctors;
      $q('#k_appointments').textContent = totalAppts;
      $q('#k_present').textContent = present;
      $q('#k_percent').textContent = percent + '%';
    }

    function getStaticDoctors(){
      return ['Dr. Ayesha Singh','Dr. Raj Mehta','Dr. Priya Kapoor','Dr. Vikram Sharma'];
    }

    function renderAppointments(filter){
      var appts=load(apptKey);
      if(filter){
        var q=filter.toLowerCase();
        appts=appts.filter(a=>(a.name||'').toLowerCase().includes(q)||(a.doctor||'').toLowerCase().includes(q));
      }
      var tbody=$q('#apptTable tbody'); tbody.innerHTML='';
      appts.slice().reverse().forEach((a,i)=>{
        var tr=document.createElement('tr');
        tr.innerHTML = '<td>'+(escapeHTML(a.name)||'‚Äî')+'</td><td>'+escapeHTML(a.doctor||'‚Äî')+'</td><td>'+escapeHTML(a.date||'‚Äî')+'</td><td>'+escapeHTML(a.time||'‚Äî')+'</td><td><div class="row-actions"><button data-i="'+i+'" class="editAppt btn ghost">Edit</button><button data-i="'+i+'" class="delAppt btn ghost">Delete</button></div></td>';
        tbody.appendChild(tr);
      });
      chartAppointments();
    }

    function renderAttendance(filter){
      var atts=load(attKey);
      if(filter){
        var q=filter.toLowerCase();
        atts=atts.filter(a=>(a.name||'').toLowerCase().includes(q)||(a.note||'').toLowerCase().includes(q));
      }
      var tbody=$q('#attTable tbody'); tbody.innerHTML='';
      atts.slice().reverse().forEach((a,i)=>{
        var tr=document.createElement('tr');
        var statusBadge = a.status==='Present' ? '<span style="color:#22c55e;font-weight:700">Present</span>' : '<span style="color:#ef4444;font-weight:700">Absent</span>';
        tr.innerHTML = '<td>'+(escapeHTML(a.name)||'‚Äî')+'</td><td>'+statusBadge+'</td><td>'+escapeHTML(a.note||'‚Äî')+'</td><td>'+escapeHTML(a.time||'‚Äî')+'</td><td><div class="row-actions"><button data-i="'+i+'" class="delAtt btn ghost">Delete</button></div></td>';
        tbody.appendChild(tr);
      });
      chartAttendance();
    }

    function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]})}

    function chartAttendance(){
      var ctx=$q('#donutChart').getContext('2d');
      var atts=load(attKey);
      var today=todayKey();
      var todayAtt=atts.filter(r=> (r.dateKey|| (r.time && r.time.slice(0,10))) === today);
      var present = todayAtt.filter(r=>r.status==='Present').length;
      var absent = todayAtt.filter(r=>r.status==='Absent').length;
      var w=$q('#donutChart').width, h=$q('#donutChart').height;
      ctx.clearRect(0,0,w,h);
      var total = present+absent || 1;
      var start = -Math.PI/2;
      var presentAngle = (present/total)*Math.PI*2;
      ctx.lineWidth=20;
      ctx.beginPath(); ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.arc(w/2,h/2,Math.min(w,h)/2 - 22,0,Math.PI*2); ctx.stroke();
      var g=ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#06b6d4'); g.addColorStop(1,'#a78bfa');
      ctx.beginPath(); ctx.strokeStyle=g; ctx.arc(w/2,h/2,Math.min(w,h)/2 - 22, start, start + presentAngle); ctx.stroke();
      ctx.fillStyle='#e6eef8'; ctx.font='700 18px Inter, sans-serif'; ctx.textAlign='center'; ctx.fillText(present, w/2, h/2-2);
      ctx.fillStyle='rgba(255,255,255,0.65)'; ctx.font='400 12px Inter, sans-serif'; ctx.fillText('Present', w/2, h/2+16);
    }

    function chartAppointments(){
      var ctx=$q('#barChart').getContext('2d');
      var appts=load(apptKey);
      var counts={};
      appts.forEach(a=>{ counts[a.doctor]=(counts[a.doctor]||0)+1 });
      var doctors = Object.keys(counts).length ? Object.keys(counts) : getStaticDoctors();
      var values = doctors.map(d=>counts[d]||0);
      var w=$q('#barChart').width, h=$q('#barChart').height;
      ctx.clearRect(0,0,w,h);
      var max = Math.max(1, ...values);
      var pad=40, barW = (w - pad*2) / doctors.length * 0.6;
      doctors.forEach(function(d,i){
        var x = pad + i*((w-pad*2)/doctors.length) + ((w-pad*2)/doctors.length - barW)/2;
        var bh = (values[i]/max) * (h - 80);
        ctx.fillStyle = 'rgba(255,255,255,0.07)';
        ctx.fillRect(x, h-40-bh, barW, bh);
        var g=ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#06b6d4'); g.addColorStop(1,'#a78bfa');
        ctx.fillStyle = g;
        ctx.fillRect(x, h-40-bh, barW, bh*0.95);
        ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.font='700 12px Inter, sans-serif'; ctx.textAlign='center';
        ctx.fillText(values[i], x+barW/2, h-48-bh);
        ctx.fillStyle='rgba(255,255,255,0.7)'; ctx.font='600 12px Inter, sans-serif';
        ctx.fillText(d, x+barW/2, h-14);
      });
    }

    function exportCSV(data, headers, filename){
      var q=[headers.join(',')];
      data.forEach(r=>{ q.push(headers.map(h=>'\"'+String(r[h]||'').replace(/"/g,'""')+'\"').join(',')) });
      var blob=new Blob([q.join('\n')],{type:'text/csv'}); var url=URL.createObjectURL(blob);
      var a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function importCSVFile(file, key){
      var r=new FileReader();
      r.onload=function(e){
        try{
          var text=e.target.result; var lines=text.split(/\r?\n/).filter(Boolean); var header = lines.shift().split(',').map(h=>h.replace(/"/g,'').trim());
          var arr = load(key);
          lines.forEach(function(line){
            var cols=line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
            var obj={};
            header.forEach((h,i)=> obj[h]= (cols[i]||'').replace(/^"|"$/g,''));
            if(key===apptKey){
              arr.push({name:obj.name||'Unknown', doctor: obj.doctor||'', date: obj.date||'', time: obj.time||'', note: obj.note||''});
            } else {
              arr.push({id: obj.id || ('I'+Date.now()), name: obj.name || 'Unknown', status: obj.status || 'Present', time: obj.time || fmt(new Date()), note: obj.note || '', dateKey: obj.dateKey || todayKey()});
            }
          });
          save(key,arr); renderAll(); toast('Import done');
        }catch(e){ toast('Import failed') }
      }; r.readAsText(file);
    }

    function confirmModal(title, body, cb){
      $q('#modalTitle').textContent=title; $q('#modalBody').textContent=body;
      $q('#modal').classList.add('show'); $q('#modal').setAttribute('aria-hidden','false');
      var ok = $q('#modalOk'), cancel=$q('#modalCancel');
      function done(){ $q('#modal').classList.remove('show'); $q('#modal').setAttribute('aria-hidden','true'); ok.removeEventListener('click',onOk); cancel.removeEventListener('click',onCancel) }
      function onOk(){ done(); cb(true) }
      function onCancel(){ done(); cb(false) }
      ok.addEventListener('click', onOk); cancel.addEventListener('click', onCancel);
    }

    function renderAll(){
      computeKPIs(); renderAppointments($q('#apptSearch').value||''); renderAttendance($q('#attSearch').value||'');
      $q('#lastUpdate').textContent = 'Updated ' + new Date().toLocaleString();
    }

    $q('#refreshBtn').addEventListener('click', function(){ renderAll(); toast('Refreshed') });
    $q('#apptSearch').addEventListener('input', function(){ renderAppointments(this.value) });
    $q('#attSearch').addEventListener('input', function(){ renderAttendance(this.value) });

    $q('#openAppointments').addEventListener('click', function(){ location.href='appointment.html' });

    $q('#exportAppointments').addEventListener('click', function(){
      var arr=load(apptKey); exportCSV(arr,['name','doctor','date','time','note'],'appointments_export.csv')
    });
    $q('#exportAttendance').addEventListener('click', function(){
      var arr=load(attKey); exportCSV(arr,['id','name','status','time','note','dateKey'],'attendance_export.csv')
    });

    $q('#importAppointmentsBtn').addEventListener('click', function(){ $q('#importAppointmentsFile').click() });
    $q('#importAppointmentsFile').addEventListener('change', function(e){ var f=e.target.files[0]; if(f) importCSVFile(f, apptKey); e.target.value=''; });

    $q('#importAttendanceBtn').addEventListener('click', function(){ $q('#importAttendanceFile').click() });
    $q('#importAttendanceFile').addEventListener('change', function(e){ var f=e.target.files[0]; if(f) importCSVFile(f, attKey); e.target.value=''; });

    $q('#clearAppointments').addEventListener('click', function(){
      confirmModal('Clear appointments','Delete all appointments permanently?', function(ok){
        if(ok){ save(apptKey,[]); renderAll(); toast('Appointments cleared') }
      });
    });
    $q('#clearAttendance').addEventListener('click', function(){
      confirmModal('Clear attendance','Delete all attendance permanently?', function(ok){
        if(ok){ save(attKey,[]); renderAll(); toast('Attendance cleared') }
      });
    });

    $q('#exportAllBtn').addEventListener('click', function(){
      var a=load(apptKey), b=load(attKey);
      exportCSV(a,['name','doctor','date','time','note'],'appointments_export.csv');
      exportCSV(b,['id','name','status','time','note','dateKey'],'attendance_export.csv');
    });

    $q('#importAllBtn').addEventListener('click', function(){ $q('#importAllFile').click() });
    $q('#importAllFile').addEventListener('change', function(e){
      var f=e.target.files[0]; if(!f) return; importCSVFile(f, apptKey); importCSVFile(f, attKey); e.target.value='';
    });

    $q('#clearAllBtn').addEventListener('click', function(){
      confirmModal('Clear all data','This will clear appointments and attendance. Continue?', function(ok){
        if(ok){ save(apptKey,[]); save(attKey,[]); renderAll(); toast('All storage cleared') }
      });
    });

    $q('#exportAtt').addEventListener('click', function(){
      var a=load(attKey); exportCSV(a,['id','name','status','time','note','dateKey'],'attendance_export.csv')
    });

    $q('#addSampleAppt').addEventListener('click', function(){
      var arr = load(apptKey);
      var d = new Date(); var dt = (d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'));
      arr.push({name:'Sample Patient '+(arr.length+1), doctor: getStaticDoctors()[arr.length%4], date: dt, time: String(d.getHours()).padStart(2,'0')+':00', note:'Auto sample'});
      save(apptKey,arr); renderAll(); toast('Sample appointment added'); burst();
    });

    $q('#importAllBtn').addEventListener('click', function(){ $q('#importAllFile').click() });

    $q('#exportAllBtn').addEventListener('click', function(){ $q('#exportAllBtn').click() });

    $q('#themeToggle').addEventListener('click', function(){
      document.documentElement.style.setProperty('--accent1', document.documentElement.style.getPropertyValue('--accent1') === '#06b6d4' ? '#f97316' : '#06b6d4');
      document.documentElement.style.setProperty('--accent2', document.documentElement.style.getPropertyValue('--accent2') === '#a78bfa' ? '#fb7185' : '#a78bfa');
      toast('Accent toggled');
    });

    document.body.addEventListener('click', function(e){
      if(e.target.matches('.delAppt')) {
        var idx = Number(e.target.getAttribute('data-i')); var arr=load(apptKey);
        var actualIndex = arr.length-1-idx;
        confirmModal('Delete appointment','Delete this appointment?', function(ok){ if(ok){ arr.splice(actualIndex,1); save(apptKey,arr); renderAll(); toast('Deleted') }});
      }
      if(e.target.matches('.editAppt')) {
        var idx = Number(e.target.getAttribute('data-i')); var arr=load(apptKey);
        var actualIndex = arr.length-1-idx; var a=arr[actualIndex];
        var newName = prompt('Patient name', a.name||''); if(newName===null) return;
        a.name=newName; arr[actualIndex]=a; save(apptKey,arr); renderAll(); toast('Updated');
      }
      if(e.target.matches('.delAtt')) {
        var idx = Number(e.target.getAttribute('data-i')); var arr=load(attKey);
        var actualIndex = arr.length-1-idx;
        confirmModal('Delete attendance','Delete this attendance record?', function(ok){ if(ok){ arr.splice(actualIndex,1); save(attKey,arr); renderAll(); toast('Deleted') }});
      }
    });

    $q('#importAllFile').addEventListener('change', function(e){
      var f=e.target.files[0]; if(!f) return;
      importCSVFile(f, apptKey); importCSVFile(f, attKey); e.target.value='';
    });

    $q('#exportAttendance').addEventListener('click', function(){ var a=load(attKey); exportCSV(a,['id','name','status','time','note','dateKey'],'attendance_export.csv') });

    setInterval(function(){ $q('#nowClock').textContent = new Date().toLocaleTimeString(); }, 1000);

    renderAll();

    window.addEventListener('storage', function(e){ if(e.key===apptKey || e.key===attKey) renderAll() });

  })();
  </script>
</body>
</html>
