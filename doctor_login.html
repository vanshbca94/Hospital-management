<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HMS — Doctor Login</title>

  <link rel="stylesheet" href="css/style.css" />
  <style>
    :root { --accent1:#06b6d4; --accent2:#a78bfa; }
    body { margin:0; min-height:100vh; font-family:"Poppins",system-ui; background:radial-gradient(circle at 5% 10%, rgba(6,182,212,0.06), transparent 8%), linear-gradient(180deg,#071229 0%, #040a18 100%); color:#e6eef8; -webkit-font-smoothing:antialiased; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card { width:100%; max-width:960px; display:grid; grid-template-columns:1fr 420px; gap:28px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:26px; box-shadow:0 12px 40px rgba(0,0,0,0.6); }
    @media(max-width:980px){ .card{ grid-template-columns:1fr; } }
    .panel{ padding:18px; }
    h1{ margin:0 0 8px; font-size:1.6rem; background:linear-gradient(90deg,var(--accent1),var(--accent2)); -webkit-background-clip:text; color:transparent; }
    p.lead{ color:#9ca3af; margin-top:6px; margin-bottom:18px; }
    .input { width:100%; padding:12px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:#fff; margin-bottom:12px; outline:none; }
    .btn { padding:12px 14px; border-radius:12px; border:none; background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#fff; font-weight:700; cursor:pointer; display:inline-block; }
    .muted { color:#9ca3af; font-size:0.94rem; }
    .note { font-size:0.9rem; color:#9ca3af; margin-top:10px; }
    .illustration{ display:flex; align-items:center; justify-content:center; }
    .toast{ display:none; position:fixed; left:50%; transform:translateX(-50%); bottom:28px; background:#081026; color:#fff; padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); z-index:9999; }
    .toast.show{ display:block; animation:pop .28s ease; }
    @keyframes pop{ from{ transform:translateX(-50%) translateY(6px); opacity:0 } to{ transform:translateX(-50%) translateY(0); opacity:1 } }
    .small-link{ color:#cbd5e1; text-decoration:none; font-size:0.92rem; }
  </style>
</head>
<body>
  <div class="card" role="main">
    <section class="panel" aria-labelledby="title">
      <h1 id="title">Doctor / Admin Sign In</h1>
      <p class="lead">Only accounts with role <strong>doctor</strong> or <strong>admin</strong> can access registration pages.</p>

      <form id="loginForm" autocomplete="off">
        <input id="email" class="input" type="email" placeholder="Email" required />
        <input id="password" class="input" type="password" placeholder="Password" required />
        <div style="display:flex;gap:10px;align-items:center;">
          <button id="submitBtn" class="btn" type="submit">Sign In</button>
          <button id="demoCreate" type="button" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cbd5e1;font-weight:700;">Create Demo Doctor</button>
        </div>
        <div id="err" class="note" style="color:#ffb4b4;display:none"></div>
      </form>

      <p class="note">If you were redirected here, you'll be returned to the original page after login.</p>
    </section>

    <aside class="panel illustration" aria-hidden="true">
      <img src="https://cdn-icons-png.flaticon.com/512/2966/2966485.png" alt="Hospital" width="280" style="border-radius:12px;filter:drop-shadow(0 16px 36px rgba(0,0,0,0.6));">
      <p style="margin-top:12px" class="muted">Use the demo create button to seed a doctor account locally for testing. In production, admins should create accounts via secure backend.</p>
    </aside>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // small helpers
    const toast = (t) => { const el = document.getElementById('toast'); el.textContent = t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2000); };

    // retrieve 'next' query param (so register_doctor.html ?next=.. works)
    function getNext() {
      const u = new URL(location.href);
      return u.searchParams.get('next') ? decodeURIComponent(u.searchParams.get('next')) : null;
    }

    // user storage helpers
    function readUsers(){
      try { return JSON.parse(localStorage.getItem('hms_users') || '[]'); } catch(e){ console.warn(e); return []; }
    }
    function saveUsers(arr){ localStorage.setItem('hms_users', JSON.stringify(arr)); }

    // ensure there's at least one admin for testing
    const ensureAdmin = () => {
      const u = readUsers();
      if(!u.find(x=>x.email==='admin@hms.test')){
        u.push({ email:'admin@hms.test', password:'admin123', name:'Admin', role:'admin' });
        saveUsers(u);
        console.info('Demo admin seeded: admin@hms.test / admin123');
      }
    };
    ensureAdmin();

    // create demo doctor account (for testing)
    document.getElementById('demoCreate').addEventListener('click', (e) => {
      const u = readUsers();
      const email = 'dr.demo@hms.test';
      if(u.find(x=>x.email === email)){
        toast('Demo doctor already exists — use dr.demo@hms.test / demo123');
        return;
      }
      u.push({ email, password:'demo123', name:'Dr Demo', role:'doctor' });
      saveUsers(u);
      toast('Demo doctor created: dr.demo@hms.test / demo123');
    });

    // sign-in logic (localStorage)
    const form = document.getElementById('loginForm');
    const err = document.getElementById('err');
    form.addEventListener('submit', (ev) => {
      ev.preventDefault();
      err.style.display = 'none';
      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;

      if(!email || !password){ err.textContent='Enter email & password.'; err.style.display='block'; return; }

      const users = readUsers();
      const found = users.find(u => u.email.toLowerCase() === email && u.password === password);

      if(!found){
        err.textContent = 'Invalid credentials. (Hint: use demo account or seed an account)';
        err.style.display = 'block';
        return;
      }

      if(found.role !== 'doctor' && found.role !== 'admin'){
        err.textContent = `This user is role "${found.role}". Use the correct login page.`;
        err.style.display = 'block';
        return;
      }

      // Save canonical current user key that other pages expect:
      const current = { email: found.email, name: found.name || found.email, role: found.role };
      localStorage.setItem('hmsCurrentUser', JSON.stringify(current));
      localStorage.setItem('hms_user', JSON.stringify(current)); // be permissive: write both keys

      toast('Signed in — redirecting...');
      const next = getNext();
      setTimeout(() => {
        if(next) location.href = next;
        else location.href = 'register_doctor.html';
      }, 700);
    });

    // Accessibility: enter key on inputs should submit; already default
  </script>
</body>
</html>
