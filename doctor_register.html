<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Register Doctor - HMS</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    :root {
      --accent1: #06b6d4;
      --accent2: #a78bfa;
      --bg: #0f172a;
      --card: rgba(255,255,255,0.04);
      --muted: #94a3b8;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Poppins',system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(circle at top,#071229,#061025);
      color:#e6eef8;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .card {
      width:100%;
      max-width:560px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
      border-radius:12px;
      padding:26px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      position:relative;
    }
    .card h2 {
      margin:0 0 6px 0;
      font-size:1.4rem;
      background: linear-gradient(90deg,var(--accent1),var(--accent2));
      -webkit-background-clip:text;
      color:transparent;
    }
    .sub { color:var(--muted); margin-bottom:16px; font-size:0.95rem; }
    label { display:block; font-size:0.85rem; color:var(--muted); margin-top:10px; margin-bottom:6px; }
    input, select {
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:none;
      background: rgba(255,255,255,0.04);
      color:#e6eef8;
      outline:none;
      font-size:0.95rem;
    }
    input:focus, select:focus { box-shadow:0 8px 30px rgba(6,182,212,0.06); transform:translateY(-2px) }
    .row { display:flex; gap:10px; margin-top:12px; }
    .btn {
      padding:12px 14px;
      border-radius:10px;
      border:none;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    .btn.ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); font-weight:600 }
    .small { font-size:0.9rem; color:var(--muted); margin-top:10px; }
    .doctors-list { margin-top:18px; display:grid; gap:12px; max-height:300px; overflow:auto; padding-right:6px; }
    .doctor-item {
      background: rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.03);
      padding:10px;
      border-radius:10px;
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    .doctor-left { display:flex; gap:12px; align-items:center; }
    .avatar { width:56px; height:56px; border-radius:50%; object-fit:cover; border:2px solid var(--accent1); }
    .meta { display:flex; flex-direction:column; }
    .meta strong { font-size:0.98rem; }
    .meta span { font-size:0.85rem; color:var(--muted); }
    .status { font-weight:700; padding:6px 10px; border-radius:999px; font-size:0.82rem; }
    .status.available { background:#063; color:#dfffe6; }
    .status.busy { background:#3b1a1a; color:#ffd6d6; }
    .admin-only { display:none; }
    .msg { margin-top:12px; padding:10px; border-radius:8px; font-size:0.94rem; }
    .msg.warn { background: rgba(127,29,29,0.7); color:#fff; border:1px solid rgba(255,255,255,0.04); }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:22px; background:#061228; color:#e6eef8; padding:10px 14px; border-radius:10px; display:none; border:1px solid rgba(255,255,255,0.03); z-index:9999; }
    footer { text-align:center; margin-top:12px; font-size:0.85rem; color:var(--muted) }
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="title">
    <div id="accessBadge" class="small">ðŸ”’ Doctor / Admin Only</div>
    <h2 id="title">Register Doctor</h2>
    <p class="sub">Add doctors to the system â€” they will appear in the Doctors page and be selectable for appointments. Only signed-in doctors/admins can access this page.</p>

    <div id="accessMsg" class="msg warn" style="display:none"></div>

    <form id="registerForm" aria-label="register doctor form">
      <label for="name">Full name</label>
      <input id="name" placeholder="e.g. Dr. Ayesha Singh" required />

      <label for="specialty">Specialty</label>
      <input id="specialty" placeholder="e.g. Cardiologist" required />

      <label for="status">Status</label>
      <select id="status" required>
        <option value="">Select status</option>
        <option value="available">available</option>
        <option value="busy">busy</option>
      </select>

      <label for="image">Image URL (optional)</label>
      <input id="image" placeholder="https://... or leave empty for default" />

      <div class="row" style="margin-top:14px">
        <button id="saveBtn" class="btn" type="submit">Register Doctor</button>
        <button id="resetBtn" type="button" class="btn ghost">Reset</button>
      </div>
    </form>

    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:16px">
      <strong style="font-size:1rem">Registered Doctors</strong>
      <a href="doctors.html" class="small">Open Doctors â†’</a>
    </div>

    <div id="doctorsList" class="doctors-list" aria-live="polite"></div>

    <div class="small" style="margin-top:12px">Note: The system will attempt to save to Firestore. If Firestore is unavailable or your account lacks permissions, it will store data locally in your browser.</div>

    <footer>Â© 2025 HMS â€¢ Managed by Vansh</footer>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    // minimal helpers
    const $ = id => document.getElementById(id);
    function toast(msg, t = 1800){ const el = $('toast'); el.textContent = msg; el.style.display = 'block'; setTimeout(()=> el.style.display = 'none', t); }

    // Read current logged-in user from localStorage/sessionStorage
    function getCurrentUser(){
      try {
        return JSON.parse(localStorage.getItem('hmsCurrentUser') || sessionStorage.getItem('hmsCurrentUser') || 'null');
      } catch(e){ return null; }
    }

    const currentUser = getCurrentUser();
    const allowed = currentUser && (currentUser.role === 'doctor' || currentUser.role === 'admin');
    if(!allowed){
      const msg = $('accessMsg');
      msg.textContent = 'Access denied. Only logged-in doctors or admins can access this page. Redirecting to login...';
      msg.style.display = 'block';
      setTimeout(()=> location.href = `doctor_login.html?next=${encodeURIComponent(location.pathname)}`, 900);
    }

    // Firestore optional integration
    let firestoreAvailable = false;
    let db = null;
    try {
      import('https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js').then(({ initializeApp }) => {
        import('https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js').then(({ getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where }) => {
          const firebaseConfig = {
            apiKey: "AIzaSyB1F-08xqgsdTR9oGmNqtFzlBJNv86UVpM",
            authDomain: "hospital-management-5cb17.firebaseapp.com",
            projectId: "hospital-management-5cb17",
            storageBucket: "hospital-management-5cb17.firebasestorage.app",
            messagingSenderId: "1077408582965",
            appId: "1:1077408582965:web:21668368b4793cf98f107c",
            measurementId: "G-JEY8DE5FC9"
          };
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          firestoreAvailable = true;
          loadDoctorsFromFirestore();
        }).catch(()=> {
          firestoreAvailable = false;
          loadDoctorsFromLocal();
        });
      }).catch(()=> {
        firestoreAvailable = false;
        loadDoctorsFromLocal();
      });
    } catch (e) {
      firestoreAvailable = false;
      loadDoctorsFromLocal();
    }

    // local storage helpers
    function readLocalDoctors(){
      try { return JSON.parse(localStorage.getItem('hmsDoctors') || '[]'); } catch(e){ return []; }
    }
    function saveLocalDoctors(list){
      localStorage.setItem('hmsDoctors', JSON.stringify(list));
    }

    // render
    function renderDoctors(list){
      const container = $('doctorsList');
      container.innerHTML = '';
      if(list.length === 0){
        container.innerHTML = '<div class="small">No doctors yet.</div>';
        return;
      }
      list.forEach(d => {
        const item = document.createElement('div');
        item.className = 'doctor-item';
        const left = document.createElement('div');
        left.className = 'doctor-left';
        const img = document.createElement('img');
        img.className = 'avatar';
        img.src = d.image || 'https://cdn-icons-png.flaticon.com/512/2966/2966485.png';
        img.alt = d.name;
        const meta = document.createElement('div');
        meta.className = 'meta';
        const nameEl = document.createElement('strong'); nameEl.textContent = d.name;
        const sp = document.createElement('span'); sp.textContent = d.specialty;
        meta.appendChild(nameEl); meta.appendChild(sp);
        left.appendChild(img); left.appendChild(meta);

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.alignItems = 'center';
        right.style.gap = '10px';

        const st = document.createElement('div');
        st.className = 'status ' + (d.status === 'available' ? 'available' : 'busy');
        st.textContent = d.status === 'available' ? 'Available' : 'Busy';
        right.appendChild(st);

        if(currentUser && currentUser.role === 'admin'){
          const del = document.createElement('button');
          del.className = 'btn ghost admin-only';
          del.textContent = 'Remove';
          del.style.padding = '8px 10px';
          del.addEventListener('click', () => deleteDoctorAction(d));
          right.appendChild(del);
          del.style.display = 'inline-flex';
        }

        item.appendChild(left);
        item.appendChild(right);
        container.appendChild(item);
      });
    }

    // loaders
    async function loadDoctorsFromFirestore(){
      try {
        const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js');
        const qSnap = await getDocs(collection(db, 'doctors'));
        const arr = [];
        qSnap.forEach(s => { const dat = s.data(); dat._id = s.id; arr.push(dat); });
        renderDoctors(arr);
        return arr;
      } catch (err) {
        firestoreAvailable = false;
        loadDoctorsFromLocal();
      }
    }

    function loadDoctorsFromLocal(){
      const arr = readLocalDoctors();
      renderDoctors(arr);
      return arr;
    }

    function getDoctorsList(){
      if(firestoreAvailable) return loadDoctorsFromFirestore();
      return loadDoctorsFromLocal();
    }

    // submit handler: try firestore first, fallback to local
    $('registerForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const name = $('name').value.trim();
      const specialty = $('specialty').value.trim();
      const status = $('status').value;
      const image = $('image').value.trim() || 'https://cdn-icons-png.flaticon.com/512/2966/2966485.png';

      if(!name || !specialty || !status){
        toast('Please fill all required fields.');
        return;
      }

      const docObj = { name, specialty, status, image, createdAt: new Date().toISOString() };

      if(firestoreAvailable){
        try {
          const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js');
          await addDoc(collection(db, 'doctors'), docObj);
          toast('Doctor added to Firestore.');
          $('registerForm').reset();
          setTimeout(()=> getDoctorsList(), 500);
          return;
        } catch (err) {
          firestoreAvailable = false;
          toast('Firestore write failed (permissions/network). Falling back to local storage.');
        }
      }

      // fallback: local storage
      const local = readLocalDoctors();
      const id = 'L' + Date.now();
      local.push(Object.assign({ _id: id }, docObj));
      saveLocalDoctors(local);
      toast('Doctor saved locally.');
      $('registerForm').reset();
      renderDoctors(local);
    });

    // delete action: admin-only
    async function deleteDoctorAction(d){
      if(!confirm('Remove doctor "' + d.name + '"? This cannot be undone.')) return;
      if(!currentUser || currentUser.role !== 'admin'){
        alert('Only admin can remove doctors.');
        return;
      }

      if(firestoreAvailable && d._id && !d._id.startsWith('L')){
        try {
          const { doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js');
          await deleteDoc(doc(db, 'doctors', d._id));
          toast('Doctor removed from Firestore.');
          setTimeout(()=> getDoctorsList(), 300);
          return;
        } catch (err) {
          firestoreAvailable = false;
          toast('Failed to remove from Firestore. Falling back to local removal.');
        }
      }

      // fallback remove from local
      const local = readLocalDoctors().filter(x => x._id !== d._id);
      saveLocalDoctors(local);
      renderDoctors(local);
      toast('Doctor removed locally.');
    }

    // reset button
    $('resetBtn').addEventListener('click', () => {
      $('registerForm').reset();
    });

    // initial load
    getDoctorsList();

    // make sure admin-only buttons show if admin - rendered in renderDoctors
  </script>
</body>
</html>
